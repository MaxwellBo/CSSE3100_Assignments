% \RequirePackage[l2tabu, orthodox]{nag}

\documentclass[a4paper]{article}
\usepackage{fullpage}
\usepackage{oz}
\usepackage{definitions}
\usepackage{todonotes}
% \usepackage{amsmath}
% \usepackage{amssymb}

\newcommand{\LEN}{\mbox{len}}
\newcommand{\PRE}{lrun(A, n, n + 1)}
\newcommand{\POST}{mrun(A, n_0, m)}
\newcommand{\INV}{lrun(A, n_0, m)}
\newcommand{\ENV}{n, m}
\newcommand{\ASSIGNMENT}{m := n + 1}
\newcommand{\GUARD}{(m < A.\LEN \land A_{n_{0}} = A_m)}
\newcommand{\MRUN}[3]{lrun({#1}, {#2}, {#3}) \land ({#3} < {#1}.\LEN \Rightarrow {#1}_{#2} \neq {#1}_{#3})}
\newcommand{\IMPLIESEXPANSION}[2]{\neg ({#1}) \lor ({#2})}
\newcommand{\VARIANTEXP}{(0 \leqslant V < V_0)}


\newcommand{\PREP}{A.\LEN > 0}
\newcommand{\POSTP}{mrun(A, \ell, h) \land (\forall p, q \,\cdot\, mrun(A, p, q) \Rightarrow (h - \ell) \leqslant (q - p))}
\newcommand{\ENVP}{\ell, h}
\newcommand{\INVP}{mrun(A, \ell, h)}

\newcommand{\INNERLOOPPOSTEXPANSION}{lrun(A, n_0, m + 1) \land (0 \leqslant (A.\LEN - (m + 1)) < (A.\LEN - m))}



\title{\bf Assignment 3: Derivation}
\author{Maxwell Bo ~~ 43926871}

\begin{document}
\maketitle

% \DERIVE
% \form{inv[i,j\backslash 0,1]}
% \hint{\equiv}{definition of $inv$}
% \form{max(A,0,j,i)[i,j\backslash 0,1]}
% \hint{\equiv}{apply substitution}
% \form{max(A,0,1,0)}
% \hint{\equiv}{since $A_0$ only element in $A_{[0,1)}$}
% \form{\true}
% \ENDDERIVE


\begin{enumerate}
	\item 
	\begin{enumerate}
		\item $n$ is a \textbf{value} parameter. $m$ is a \textbf{result} parameter.
		\item Our post-condition, $\POST$, expands to $\MRUN{A}{n_0}{m}$. This satisfies the form $Q \triangleq Q_1 \land Q_2$. $Q_1$ was chosen as the invariant. Thus,


		\begin{eqnarray*}
		inv & \triangleq & \INV
		\end{eqnarray*}
		\item 

Let

\begin{eqnarray*}
pre & \triangleq & \PRE\\
post & \triangleq & \POST
\end{eqnarray*}

s.t.

\DERIVE
\form{\ENV : [pre,\, post]}
\hint{\refsto} {Composition: middle predicate is $inv$}
\form{\ENV : [pre,\, inv];\ \ENV : [inv,\, post]}
\hint{\refsto} {Assignment: $pre \entails inv[m \backslash n + 1]$}
\form{\ASSIGNMENT;\ \ENV: [inv,\, post]}
\ENDDERIVE

$\because$

\begin{eqnarray*}
inv[m \backslash n + 1] & \equiv & \INV[m \backslash n + 1]\\
& \equiv & lrun(A, n_0, n + 1)
\end{eqnarray*}

$\therefore$ 

\begin{eqnarray*}
\PRE & \entails & lrun(A, n_0, n + 1)
\end{eqnarray*}


Let


\begin{eqnarray*}
guard & \triangleq & \GUARD
\end{eqnarray*}

s.t.

\DERIVE
\hint{\refsto} {Strengthen post: $inv \land \neg guard ~\entails~ post$}
\form{\ASSIGNMENT;\ \ENV: [inv,\, inv \land \neg guard]}
\ENDDERIVE

$\because$

\DERIVE
\form{inv \land \neg guard ~\entails~ post}
\hint{\equiv} {Expansion of definitions}
\form{\INV \land \neg \GUARD ~\entails~ \POST}
\hint{\equiv} {Expansion of functions}
\form{\INV \land \neg \GUARD ~\entails~ \MRUN{A}{n_0}{m}}
\hint{\equiv} {De Morgan's law - negation of conjunction}
\form{\INV \land (\neg (m < A.\LEN) \lor \neg (A_{n_{0}} = A_m)) ~ \entails~ \MRUN{A}{n_0}{m}}
\hint{\equiv} {$P \Rightarrow Q  ~\equiv~ \neg P \lor Q$}
\form{\INV \land (\neg (m < A.\LEN) \lor \neg (A_{n_{0}} = A_m)) ~ \entails~ lrun(A, n_0, m) \land (\IMPLIESEXPANSION{m < A.\LEN}{A_{n_{0}} \neq A_m})}
\hint{\equiv} {}
\form{\true}
\ENDDERIVE



\DERIVE
\hint{\refsto} {Repetition}
\form{
\begin{array}{l}
\ASSIGNMENT;\\
\Do~ \GUARD \rightarrow\\
    \t1 \ENV:[inv \land guard,\, inv \land \VARIANTEXP]\\
\Od\\
\end{array}}
\ENDDERIVE

where

\begin{eqnarray*}
V & \triangleq & A.\LEN ~-~ m
\end{eqnarray*}

\DERIVE
\hint{\refsto} {Assignment: $inv \land guard ~\entails~ (inv \land \VARIANTEXP)[m \backslash m + 1]$}
\form{
\begin{array}{l}
\ASSIGNMENT;\\
\Do~ \GUARD \rightarrow\\
    \t1 m := m + 1\\
\Od\\
\end{array}}
\ENDDERIVE

$\because$

\begin{eqnarray*}
(inv \land \VARIANTEXP)[m \backslash m + 1] & \equiv & (\INV \land (0 \leqslant (A.\LEN - m) < (A.\LEN - m_0)))[m, m_0 \backslash m + 1, m]\\
 & \equiv & \INNERLOOPPOSTEXPANSION
\end{eqnarray*}

$\therefore$

\begin{eqnarray*}
inv \land guard & \entails & \INNERLOOPPOSTEXPANSION\\
\INV \land \GUARD & \entails & \INNERLOOPPOSTEXPANSION
\end{eqnarray*}

Furthermore,

\begin{eqnarray*}
m < A.\LEN & \entails & 0 \leqslant (A.\LEN - (m + 1)) < (A.\LEN - m)
\end{eqnarray*}

is trivially $\true$.\\

\begin{eqnarray*}
\INV & \entails & lrun(A, n_0, m + 1)
\end{eqnarray*}

because $A_{n_0} = A_m$, the $run(A, n_0, m + 1)$ in the deep depths of $mrun$ holds, noting that $run(A, n_0, m + 1)$ describes a run up to, but not including index $m + 1$. Thus, we are free to perform the assignment, expanding the $run$ range.


All conjuncts hold, and are entailed by the LHS.

$\qed$

	\end{enumerate}

\item

\begin{eqnarray*}
pre & \triangleq & \PREP\\
post & \triangleq & \POSTP
\end{eqnarray*}


\DERIVE
\form{\ENVP : [pre,\, post]}
\hint{\refsto} {Composition: middle predicate is $inv$}
\form{\ENVP : [pre,\, inv];\ \ENVP : [inv,\, post]}
\ENDDERIVE

where

\begin{eqnarray*}
inv & \triangleq & \INVP
\end{eqnarray*}

\DERIVE
\form{
\begin{array}{l}
\ell := 0;\\
\Do~ \GUARD \rightarrow\\
    \t1 m := m + 1\\
\Od\\
\end{array}}
\ENDDERIVE

\end{enumerate}


\end{document}
